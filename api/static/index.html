<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K8s LLM Service</title>
    <style>
        :root {
            --primary: #4F46E5;
            --primary-hover: #4338ca;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border: #e5e7eb;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 2rem;
            display: flex;
            justify-content: center;
        }

        .container {
            background-color: var(--card-bg);
            width: 100%;
            max-width: 800px;
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        h2 {
            margin-top: 0;
            color: var(--text-main);
            font-size: 1.8rem;
            font-weight: 700;
            border-bottom: 2px solid var(--border);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-main);
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .btn-group {
            margin-top: 1rem;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        #run {
            background-color: var(--primary);
            color: white;
        }

        #run:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        #run:active {
            transform: translateY(0);
        }

        #clear, #refresh-history {
            background-color: white;
            border: 1px solid var(--border);
            color: var(--text-main);
        }

        #clear:hover, #refresh-history:hover {
            background-color: #f9fafb;
            border-color: #d1d5db;
        }

        .status-bar {
            margin-top: 1.5rem;
            padding: 0.75rem;
            background-color: #f9fafb;
            border-radius: 8px;
            font-size: 0.95rem;
            color: var(--text-sub);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #status {
            font-weight: 700;
            color: var(--primary);
        }

        pre#out {
            background-color: #1e293b;
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-top: 1rem;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            min-height: 80px;
            line-height: 1.6;
        }

        .history-section {
            margin-top: 3rem;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .history-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }

        #history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .history-item {
            background: white;
            border: 1px solid var(--border);
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            transition: background 0.2s;
        }
        
        .history-item:hover {
            background-color: #f9fafb;
        }

        .history-time {
            font-size: 0.85rem;
            color: #9ca3af;
        }

        .history-prompt {
            font-weight: 500;
            color: var(--text-main);
        }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸš€ AI Prompt Service <span style="font-size:0.6em; color:#9ca3af; font-weight:normal;">(Assignment 3)</span></h2>
    
    <div>
        <label for="prompt">í”„ë¡¬í”„íŠ¸ ì…ë ¥</label>
        <textarea id="prompt" placeholder="AIì—ê²Œ ìš”ì²­í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”... (ì˜ˆ: Kubernetesê°€ ë­ì•¼?)"></textarea>
    </div>

    <div class="btn-group">
        <button id="run">â–¶ ì‹¤í–‰ (Run)</button>
        <button id="clear">ì§€ìš°ê¸°</button>
    </div>

    <div class="status-bar">
        <span>Running Status:</span>
        <span id="status">Ready</span>
    </div>

    <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">ê²°ê³¼ ì¶œë ¥</h3>
    <pre id="out">ê²°ê³¼ê°€ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤...</pre>

    <div class="history-section">
        <div class="history-header">
            <h3>ğŸ“œ ìµœê·¼ ìš”ì²­ ëª©ë¡ (History)</h3>
            <button id="refresh-history" onclick="loadHistory()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div id="history-list">
            </div>
    </div>
</div>

<script>
    const API_BASE = location.origin;
    const statusEl = document.getElementById('status');
    const outEl = document.getElementById('out');
    const historyList = document.getElementById('history-list');

    const updateStatus = (text, isError = false) => {
        statusEl.textContent = text;
        statusEl.style.color = isError ? '#ef4444' : '#4F46E5';
    };

    async function poll(jobId) {
        for (let i = 0; i < 240; i++) { 
            const r = await fetch(`${API_BASE}/api/result/${jobId}`);
            const data = await r.json();
            if (data.status === 'done') return data.data;
            
            updateStatus(`Processing... (${i+1}s)`);
            await new Promise(r => setTimeout(r, 1000));
        }
        throw new Error('Timeout: ì„œë²„ ì‘ë‹µì´ ë„ˆë¬´ ëŠ¦ìŠµë‹ˆë‹¤.');
    }

    document.getElementById('run').addEventListener('click', async () => {
        const prompt = document.getElementById('prompt').value.trim();
        if (!prompt) return alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        
        updateStatus('Requesting...'); 
        outEl.textContent = 'AIê°€ ìƒê°í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
        outEl.style.color = '#94a3b8';

        try {
            const res = await fetch(`${API_BASE}/api/run`, {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ prompt })
            });
            
            if (!res.ok) throw new Error('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');

            const j = await res.json();
            
            loadHistory(); 

            const result = await poll(j.job_id);
            outEl.style.color = '#e2e8f0';
            outEl.textContent = result.output || JSON.stringify(result, null, 2);
            updateStatus('Completed âœ…');
        } catch (e) {
            updateStatus('Error âŒ', true);
            outEl.textContent = `ì—ëŸ¬ ë°œìƒ: ${String(e)}`;
            outEl.style.color = '#fca5a5';
        }
    });

    async function loadHistory() {
        try {
            const res = await fetch(`${API_BASE}/api/history`);
            const data = await res.json();
            
            if(data.length === 0) {
                historyList.innerHTML = '<div style="text-align:center; color:#9ca3af; padding:1rem;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            historyList.innerHTML = data.map(item => `
                <div class="history-item">
                    <div class="history-time">${new Date(item.ts * 1000).toLocaleString()}</div>
                    <div class="history-prompt">${item.prompt}</div>
                    <div style="color:#4b5563; font-size:0.95rem; margin-top:4px;">
                        ${item.result ? `<strong>ì‘ë‹µ:</strong> ${String(item.result).substring(0, 140)}${String(item.result).length>140?'...':''}` : '<em>ê²°ê³¼ ì¤€ë¹„ ì¤‘...</em>'}
                    </div>
                </div>
            `).join('');
        } catch (e) { 
            console.error(e);
            historyList.innerHTML = '<div style="color:red">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
        }
    }
    
    document.getElementById('clear').onclick = () => { 
        document.getElementById('prompt').value = ''; 
        document.getElementById('prompt').focus();
    };

    loadHistory();
</script>

</body>
</html>
